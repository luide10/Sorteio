<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roleta Steam PRO</title>
    <style>
        /* ESTILOS GERAIS */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1b2838;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
        }

        /* TELAS (Login vs Jogo) */
        .screen { display: none; width: 100%; max-width: 500px; animation: fadeIn 0.5s; }
        .active-screen { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* FORMUL√ÅRIOS */
        .auth-box {
            background: rgba(0,0,0,0.3);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        input {
            width: 90%; padding: 12px; margin: 10px 0;
            border-radius: 5px; border: none; font-size: 16px;
        }
        button {
            background: #66c0f4; color: #fff; border: none;
            padding: 12px 25px; border-radius: 5px; cursor: pointer;
            font-size: 16px; font-weight: bold; width: 100%; margin-top: 10px;
        }
        button:hover { background: #419dc9; }
        
        button.secondary { 
            background: transparent; 
            border: 1px solid #66c0f4; 
            color: #66c0f4; 
        }
        button.secondary:hover { background: rgba(102, 192, 244, 0.1); }

        /* JOGO */
        .user-info {
            background: rgba(0,0,0,0.5);
            padding: 10px; border-radius: 50px;
            margin-bottom: 20px; display: inline-block;
        }
        .credits-badge {
            background: #ffcc00; color: #000; padding: 5px 10px;
            border-radius: 20px; font-weight: bold; margin-left: 10px;
        }

        .balao {
            font-size: 120px; cursor: pointer; transition: transform 0.2s;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); user-select: none;
        }
        .balao:active { transform: scale(0.9); }
        .disabled { filter: grayscale(100%); cursor: not-allowed; opacity: 0.5; pointer-events: none; }

        #result-box {
            display: none; background: #fff; color: #000; padding: 20px;
            border-radius: 10px; margin-top: 20px; border: 4px solid #66c0f4;
        }
        
        .aviso-perigo {
            color: red; font-weight: bold; font-size: 1.1em;
            background: #ffe6e6; padding: 5px; border-radius: 5px;
            margin-bottom: 10px; border: 1px solid red;
        }

        /* HIST√ìRICO DE PR√äMIOS */
        #history-panel {
            display: none;
            background: #fff; color: #333;
            padding: 20px; border-radius: 10px;
            margin-top: 20px; border: 2px solid #66c0f4;
            max-height: 300px; overflow-y: auto;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 400px; z-index: 2000;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .history-item {
            border-bottom: 1px solid #ddd;
            padding: 10px; text-align: left;
            font-size: 0.9em;
        }

        /* RODAP√â */
        footer {
            margin-top: 50px;
            color: #555;
            font-size: 0.8em;
            cursor: text;
            user-select: none; 
        }

        /* PAINEL ADMIN */
        #admin-panel {
            display: none; border-top: 2px solid #444; margin-top: 40px; padding-top: 20px;
            background: rgba(0,0,0,0.95); position: fixed; bottom: 0; left: 0; right: 0;
            height: 350px; overflow-y: scroll; padding: 20px; text-align: left;
            z-index: 1000;
        }
        .log-item { 
            font-size: 12px; border-bottom: 1px solid #333; padding: 8px; 
            color: #ddd; font-family: monospace;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading" class="loading-spinner"></div>

    <!-- TELA 1: LOGIN / CADASTRO -->
    <div id="login-screen" class="screen active-screen">
        <h1>üîê Acesso Restrito</h1>
        <div class="auth-box">
            <h3 id="form-title">Login</h3>
            <input type="email" id="email" placeholder="Seu E-mail">
            <input type="password" id="password" placeholder="Sua Senha">
            
            <button onclick="fazerLogin()">ENTRAR</button>
            <button onclick="criarConta()" class="secondary" style="margin-top: 15px;">Criar Nova Conta</button>
            
            <p style="font-size: 0.8em; margin-top: 15px; color: #aaa;">
                <b>Aten√ß√£o:</b> √â obrigat√≥rio confirmar o e-mail para jogar.
            </p>
        </div>
    </div>

    <!-- TELA 2: O JOGO -->
    <div id="game-screen" class="screen">
        <div class="user-info">
            <span id="user-email-display">usuario@email.com</span>
            <span class="credits-badge"><span id="user-credits">0</span> Chances</span>
        </div>

        <div style="margin-bottom: 20px;">
            <button onclick="toggleHistory()" style="width: auto; padding: 8px 20px; background: #4caf50; margin-right: 10px;">üéÅ Meus Pr√™mios</button>
            <button class="secondary" style="width: auto; padding: 8px 20px; font-size: 12px;" onclick="logout()">Sair</button>
        </div>

        <div id="history-panel">
            <h3 style="margin-top:0;">üìú Meu Hist√≥rico de Keys</h3>
            <div id="history-list">Carregando...</div>
            <button onclick="toggleHistory()" class="secondary" style="margin-top:10px; background:#f0f0f0;">Fechar</button>
        </div>

        <h1 style="margin-top: 20px;">Estoure para Ganhar!</h1>
        
        <div id="balao-container" onclick="playGame()">
            <div id="balao-icon" class="balao disabled">üéà</div>
            <p id="status-text" style="color: #ff5555">Carregando...</p>
        </div>

        <div id="result-box">
            <h2>üéâ Parab√©ns!</h2>
            <div class="aviso-perigo">‚ö†Ô∏è TIRE PRINT OU ANOTE AGORA!</div>
            <p>Essa key foi salva no bot√£o "Meus Pr√™mios".</p>
            
            <div style="background: #eee; padding: 15px; border-radius: 5px; margin: 15px 0;">
                <code id="key-display" style="font-size: 1.8em; color: #333; font-weight: bold; word-break: break-all;">...</code>
            </div>
            
            <small>C√≥digo √∫nico gerado em: <span id="data-geracao"></span></small>
        </div>

        <footer onclick="secretAdminTrigger()">
            <p>Desenvolvido por Luide &copy; 2025</p>
        </footer>
    </div>

    <!-- PAINEL ADMIN -->
    <div id="admin-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <h2 style="margin:0; color: orange;">üõ†Ô∏è Painel Admin</h2>
            <button style="width:auto; background:#444;" onclick="closeAdmin()">Fechar</button>
        </div>

        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 250px; background: #222; padding: 15px; border-radius: 5px; border: 1px solid #444;">
                <h3 style="margin-top:0;">1. Estoque de Keys</h3>
                <p>Keys Dispon√≠veis: <b id="total-keys-db" style="font-size: 1.5em; color: #66c0f4;">0</b></p>
                <input type="text" id="new-key-input" placeholder="Cole a Key (XXXX-XXXX-XXXX)">
                <button onclick="addKeyToDB()" style="background: #4caf50;">Salvar Key no Banco</button>
            </div>

            <div style="flex: 1; min-width: 250px; background: #222; padding: 15px; border-radius: 5px; border: 1px solid #444;">
                <h3 style="margin-top:0;">2. Dar Chances (Cr√©ditos)</h3>
                <input type="text" id="target-email" placeholder="E-mail do usu√°rio">
                <input type="number" id="amount-credits" placeholder="Qtd Chances (ex: 5)">
                <button onclick="giveCredits()" style="background: orange; color: black;">Adicionar Cr√©ditos</button>
            </div>
        </div>

        <h3 style="border-bottom: 1px solid #444; padding-bottom: 10px; margin-top: 30px;">üìú Registro de Quem Pegou (Log)</h3>
        <div id="logs-container" style="background: #000; height: 150px; overflow-y: auto; padding: 10px; border: 1px solid #333;">
            <div style="color: #666; text-align: center; padding: 20px;">Clique em "Atualizar Logs" para ver.</div>
        </div>
        <button onclick="monitorLogs()" class="secondary" style="width: 100%; margin-top: 10px;">Atualizar Logs</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCMUA_Og-8RoF_v3Dgi32obcCDy03u5biA",
            authDomain: "sorteiogemini.firebaseapp.com",
            databaseURL: "https://sorteiogemini-default-rtdb.firebaseio.com/",
            projectId: "sorteiogemini",
            storageBucket: "sorteiogemini.firebasestorage.app",
            messagingSenderId: "649756499724",
            appId: "1:649756499724:web:3c1fb49b6b9b3cc2193329"
        };

        const ADMIN_EMAIL = "luidecarx@gmail.com"; 

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let currentUser = null;
        let userCredits = 0;
        let availableKeysCount = 0;
        let podeJogar = false;

        const loginScreen = document.getElementById('login-screen');
        const gameScreen = document.getElementById('game-screen');
        const loader = document.getElementById('loading');
        const balaoIcon = document.getElementById('balao-icon');
        const statusText = document.getElementById('status-text');

        // --- SISTEMA DE LOGIN BLINDADO 2.0 ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                loginScreen.classList.remove('active-screen');
                loader.style.display = 'block';

                await user.reload().catch(e => console.log("Erro reload:", e));

                const isAdmin = (user.email === ADMIN_EMAIL);
                const isVerified = user.emailVerified;

                if (isAdmin) {
                    console.log("üëë Admin detectado. Passagem livre.");
                    permitirEntrada(user);
                } else if (isVerified) {
                    console.log("‚úÖ Usu√°rio verificado. Entrada liberada.");
                    permitirEntrada(user);
                } else {
                    console.log("üö´ N√£o verificado. Bloqueando...");
                    await auth.signOut();
                    loader.style.display = 'none';
                    loginScreen.classList.add('active-screen');
                    alert("üîí ACESSO BLOQUEADO!\n\nVoc√™ PRECISA confirmar seu e-mail antes de entrar.\nVerifique sua caixa de entrada (ou spam).");
                }
            } else {
                currentUser = null;
                podeJogar = false;
                gameScreen.classList.remove('active-screen');
                loginScreen.classList.add('active-screen');
                loader.style.display = 'none';
            }
        });

        function permitirEntrada(user) {
            currentUser = user;
            podeJogar = true;
            loader.style.display = 'none';
            gameScreen.classList.add('active-screen');
            document.getElementById('user-email-display').innerText = user.email;

            const userRef = db.ref('users/' + user.uid);
            userRef.once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    userRef.set({ email: user.email, credits: 0 });
                }
            });

            monitoruserData(user.uid);
            monitorGlobalKeys();
        }

        async function fazerLogin() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(!email || !pass) return alert("Preencha e-mail e senha");
            loader.style.display = 'block';
            try {
                await auth.signInWithEmailAndPassword(email, pass);
            } catch (error) {
                loader.style.display = 'none';
                alert("Erro ao entrar: " + error.message);
            }
        }

        async function criarConta() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(!email || !pass) return alert("Preencha e-mail e senha.");
            if(pass.length < 6) return alert("A senha precisa ter no m√≠nimo 6 d√≠gitos.");
            loader.style.display = 'block';
            try {
                const userCred = await auth.createUserWithEmailAndPassword(email, pass);
                await userCred.user.sendEmailVerification();
                await db.ref('users/' + userCred.user.uid).set({ email: email, credits: 0 });
                await auth.signOut();
                loader.style.display = 'none';
                alert("‚úÖ CONTA CRIADA!\n\nUm link de verifica√ß√£o foi enviado para o seu e-mail.\nClique nele antes de entrar.");
            } catch (error) {
                loader.style.display = 'none';
                alert("Erro ao criar conta: " + error.message);
            }
        }

        function logout() {
            auth.signOut();
            window.location.reload();
        }

        function monitoruserData(uid) {
            db.ref('users/' + uid + '/credits').on('value', (snapshot) => {
                userCredits = snapshot.val() || 0;
                document.getElementById('user-credits').innerText = userCredits;
                updateGameState();
            });
        }

        function monitorGlobalKeys() {
            db.ref('keys').on('value', (snapshot) => {
                availableKeysCount = snapshot.numChildren();
                document.getElementById('total-keys-db').innerText = availableKeysCount;
                updateGameState();
            });
        }

        function updateGameState() {
            if (userCredits > 0 && availableKeysCount > 0) {
                balaoIcon.classList.remove('disabled');
                statusText.innerText = "Clique para tentar a sorte!";
                statusText.style.color = "#66c0f4";
            } else {
                balaoIcon.classList.add('disabled');
                if (userCredits <= 0) statusText.innerText = "Sem chances (Pe√ßa ao Admin)";
                else statusText.innerText = "Keys Esgotadas :(";
                statusText.style.color = "#ff5555";
            }
        }

        async function playGame() {
            if (!podeJogar) return;
            if (userCredits <= 0) return;

            balaoIcon.classList.add('disabled');
            loader.style.display = 'block';

            try {
                const userRef = db.ref('users/' + currentUser.uid + '/credits');
                await userRef.transaction((current) => { return (current || 0) - 1; });

                const snapshot = await db.ref('keys').once('value');
                const keysData = snapshot.val();
                
                if (!keysData) throw new Error("Sem keys dispon√≠veis.");

                const keysIds = Object.keys(keysData);
                const randomId = keysIds[Math.floor(Math.random() * keysIds.length)];
                const winningKey = keysData[randomId].codigo;

                await db.ref('keys/' + randomId).remove();

                const now = new Date();
                
                await db.ref('logs').push({
                    email: currentUser.email,
                    key: winningKey,
                    data: now.toLocaleString('pt-BR')
                });

                await db.ref('users/' + currentUser.uid + '/history').push({
                    key: winningKey,
                    data: now.toLocaleString('pt-BR')
                });

                document.getElementById('result-box').style.display = 'block';
                document.getElementById('key-display').innerText = winningKey;
                document.getElementById('data-geracao').innerText = now.toLocaleTimeString();
                balaoIcon.innerText = "üí•";
                document.getElementById('balao-container').style.display = 'none';

            } catch (error) {
                console.error(error);
                const userRef = db.ref('users/' + currentUser.uid + '/credits');
                await userRef.transaction((current) => { return (current || 0) + 1; });
                alert("‚ùå ERRO: " + error.message + "\n\n‚úÖ SEU CR√âDITO FOI DEVOLVIDO!");
                balaoIcon.classList.remove('disabled');
            }
            loader.style.display = 'none';
        }

        function toggleHistory() {
            const panel = document.getElementById('history-panel');
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                return;
            }
            panel.style.display = 'block';
            const list = document.getElementById('history-list');
            list.innerHTML = "Carregando...";

            db.ref('users/' + currentUser.uid + '/history').once('value', (snapshot) => {
                const data = snapshot.val();
                list.innerHTML = "";
                if (!data) {
                    list.innerHTML = "<p style='text-align:center; color:#999;'>Voc√™ ainda n√£o ganhou nada.</p>";
                    return;
                }
                const items = Object.values(data).reverse();
                items.forEach(item => {
                    list.innerHTML += `<div class="history-item"><small style="color:#888;">${item.data}</small><br><code style="font-size:1.2em; font-weight:bold; color:#333;">${item.key}</code></div>`;
                });
            });
        }

        let secretClicks = 0;
        async function secretAdminTrigger() {
            secretClicks++;
            if (secretClicks >= 5) {
                if (currentUser && currentUser.email === ADMIN_EMAIL) {
                    alert("Bem Vindo Paiz√£o! üëëüòé");
                    document.getElementById('admin-panel').style.display = 'block';
                    monitorLogs();
                } else {
                    alert("‚õî OPA! Voc√™ n√£o √© o Admin.");
                }
                secretClicks = 0;
            }
        }

        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }

        // --- FUN√á√ÉO ATUALIZADA: CHECA DUPLICIDADE ANTES DE SALVAR ---
        async function addKeyToDB() {
            const code = document.getElementById('new-key-input').value.trim();
            if(!code) return alert("Digite a key");
            
            try {
                // VERIFICA SE A KEY J√Å EXISTE (Precisa da regra .indexOn: ["codigo"])
                const snapshot = await db.ref('keys').orderByChild('codigo').equalTo(code).once('value');
                
                if (snapshot.exists()) {
                    return alert("‚õî Erro: Essa Key J√Å EST√Å cadastrada no sistema!");
                }

                // Se n√£o existe, salva
                await db.ref('keys').push({ codigo: code });
                alert("‚úÖ Key Salva com sucesso!");
                document.getElementById('new-key-input').value = '';

            } catch (err) {
                console.error(err);
                alert("‚õî Erro: Verifique se voc√™ √© Admin e se as regras do Firebase est√£o atualizadas.");
            }
        }

        async function giveCredits() {
            const emailTarget = document.getElementById('target-email').value;
            const amount = parseInt(document.getElementById('amount-credits').value);
            if(!emailTarget || !amount) return alert("Preencha tudo");
            try {
                const snapshot = await db.ref('users').orderByChild('email').equalTo(emailTarget).once('value');
                if (!snapshot.exists()) return alert("Usu√°rio n√£o encontrado.");
                snapshot.forEach((childSnapshot) => {
                    const uid = childSnapshot.key;
                    const currentCredits = childSnapshot.val().credits || 0;
                    db.ref('users/' + uid).update({ credits: currentCredits + amount })
                        .then(() => alert(`‚úÖ +${amount} chances para ${emailTarget}`));
                });
            } catch (error) { alert("‚õî Erro de Permiss√£o."); }
        }

        function monitorLogs() {
            const container = document.getElementById('logs-container');
            container.innerHTML = "Carregando...";
            db.ref('logs').limitToLast(20).on('child_added', (snapshot) => {
                if(container.innerHTML === "Carregando...") container.innerHTML = "";
                const log = snapshot.val();
                const div = document.createElement('div');
                div.className = 'log-item';
                div.innerHTML = `<span style="color:#00ff00">[${log.data}]</span> <b style="color:orange">${log.email}</b>: <span style="color:#fff">${log.key}</span>`;
                container.prepend(div);
            }, (error) => { container.innerHTML = "<span style='color:red'>Acesso Negado.</span>"; });
        }
    </script>
</body>
</html>
